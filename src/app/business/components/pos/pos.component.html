<div class="overlay" *ngIf="!shopCode">
  <h1 class="text-white!">
    “Every great business starts with a single idea.”
  </h1>
  <h3 class="text-white!">
    Create your shop to unlock your workspace and access your Sales Machine.
  </h3>
</div>
<div class="fixed inset-0 backdrop-blur-sm flex items-center justify-center p-0 z-50 pos">
    <div class="bg-white rounded-none shadow-2xl w-full h-full flex flex-col dialog-animate">
        <!-- Dialog Header -->
        <div class="flex justify-between items-center border-b border-gray-200 py-3 px-6">
            <h2 class="text-lg font-semibold text-gray-800 m-0">
                <i class="fa-regular fa-chess-queen text-violet-600 "></i>
                Ultimate Sales Machine
            </h2>
            <button (click)="closeDialog()" class="text-gray-400 hover:text-red-500 cursor-pointer">
                <mat-icon style="color: lightcoral;">cancel</mat-icon>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-2 space-y-6">
            <!-- Your content goes here -->
            <div class="flex flex-col h-full">
                <!-- Mobile/Tablet Category Navigation -->
                <div
                    class="lg:hidden w-full p-2 overflow-hidden rounded-sm text-white flex-shrink-0 bg-violet-300 mb-4">
                    <div class="flex overflow-x-auto space-x-2 py-2 hide-scrollbar">
                        <div *ngFor="let category of categories" (click)="onCategoryChange(category.id)" [ngClass]="{
                            'bg-white text-violet-600': activeCategory === category.id,
                            'text-white bg-violet-400 hover:bg-violet-300': activeCategory !== category.id}"
                            class="flex flex-col items-center justify-center cursor-pointer px-3 py-2 rounded transition-colors min-w-max text-center">
                            <mat-icon class="mb-1 text-sm">{{ category.icon }}</mat-icon>
                            <span class="text-xs font-medium">{{ category.name }}</span>
                        </div>
                    </div>
                </div>

                <div class="flex-1 flex flex-col lg:flex-row">
                    <!-- Sidebar Navigation (Desktop only) -->
                    <div class="w-26 p-2 overflow-hidden rounded-xl text-white flex-shrink-0 hidden lg:block">
                        <nav class="flex flex-col items-center space-y-4 w-full">
                            <div *ngFor="let category of categories" (click)="onCategoryChange(category.id)" [ngClass]="{
                                'bg-violet-200 text-black': activeCategory === category.id,
                                'text-gray-600 hover:text-white hover:bg-violet-400': activeCategory !== category.id}"
                                class="flex flex-col items-center justify-center cursor-pointer px-2 py-3 rounded transition-colors w-full text-center">
                                <!-- Material icon -->
                                <mat-icon class="mb-1">{{ category.icon }}</mat-icon>

                                <span class="text-xs font-medium">{{ category.name }}</span>
                            </div>
                        </nav>
                    </div>

                    <!-- Main content -->
                    <div class="flex-1 flex flex-col overflow-hidden p-4">
                        <!-- Header -->
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                            <div class="text-lg font-medium text-gray-500">
                                {{ activeCategoryName }} Catalog
                            </div>
                            <input type="text" [(ngModel)]="searchQuery" placeholder="Search items.."
                                class="w-full sm:w-auto pl-2 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-violet-400" />
                        </div>

                        <!-- Responsive Card Grid -->
                        <div class="grid grid-cols-1 lg:grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-5">
                            <div *ngFor="let item of filteredItems"
                                class="border border-gray-200 rounded-xl shadow-sm hover:shadow-md transition-all duration-200 bg-white flex flex-col sm:flex-row">
                                <!-- Product Image -->
                                <div class="sm:w-40 flex-shrink-0">
                                    <img [src]="item.image ? item.image : placeHolderImg" [alt]="item.name"
                                        class="w-full h-40 sm:h-full object-cover rounded-t-xl sm:rounded-l-xl sm:rounded-t-none" />
                                </div>

                                <!-- Product Details -->
                                <div class="flex flex-col justify-between flex-1 p-4">
                                    <div>
                                        <h3 class="font-semibold text-base sm:text-lg text-gray-800 truncate">
                                             {{ item.name }} ({{ item.durationLabel }})
                                        </h3>
                                        <p class="text-sm text-gray-600 mt-1 line-clamp-2">
                                            {{ item.description }}
                                        </p>
                                    </div>

                                    <!-- Price & Button -->
                                    <div
                                        class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mt-3">
                                        <span class="font-medium text-green-600 text-base sm:text-lg">
                                            {{ item.basePrice.toFixed(2) | currency: 'INR':'symbol':'1.2-2' }}
                                        </span>
                                        <button (click)="addToCart(item)" mat-stroked-button
                                            class="w-full sm:w-auto px-4 py-2 text-sm sm:text-base hover:bg-green-50 transition rounded-md">
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- Single Cart Toggle for Mobile and Tablet -->
                    <div class="lg:hidden w-full mb-4">
                        <button (click)="toggleCartVisibility()"
                            class="w-full py-3 bg-violet-300 text-white rounded-sm flex justify-between items-center px-4">
                            <span class="font-medium">Shopping Cart ({{ cart.length }})</span>
                            <mat-icon>{{ isCartVisible ? 'expand_less' : 'expand_more' }}</mat-icon>
                        </button>
                    </div>

                    <!-- Right Sidebar - Collapsible on Mobile/Tablet -->
                    <div [ngClass]="{
                        'w-full lg:w-120 bg-white border-l border-gray-200 flex flex-col h-full': true,
                        'hidden lg:flex': !isCartVisible && (isMobile || isTablet),
                        'flex': isCartVisible || (!isMobile && !isTablet)
                    }">
                        <!-- Customer Info -->
                        <div class="p-4 border-b border-gray-200">
                            <h3 class="font-semibold text-lg mb-3">Customer</h3>
                            <div class="space-y-3">
                                <div (click)="openGodBoxCustomer()">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Customer</label>
                                    <div class="relative">
                                        <input type="text" [(ngModel)]="customerName" placeholder="Name or phone..."
                                            class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <i class="fa-solid fa-user absolute left-3 top-3 text-gray-400"></i>
                                    </div>
                                </div>
                                <button (click)="addCustomerMannually()" [disabled]="invoice.invoiceNumber"
                                    class="w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors">
                                    {{invoice.invoiceNumber ? invoice.invoiceNumber : "+ New Customer"}}
                                </button>
                            </div>

                        </div>

                        <!-- Shopping Cart -->
                        <div class="overflow-y-auto p-4 flex flex-col"
                            [ngStyle]="{'height': showNewCustomerForm ? '24vh' : '52vh'}">
                            <h3 class="font-semibold text-lg mb-3">Shopping Cart</h3>

                            <div *ngIf="cart.length === 0" class="text-center py-8 text-gray-500">
                                <i class="fa-regular fa-hourglass"></i>
                                <p class="mt-2">Your cart is empty</p>
                            </div>

                            <!-- Cart items with quantity controls on the right side -->
                            <div *ngFor="let item of cart; let i = index"
                                class="flex items-start border-b border-gray-100 pb-3 mb-2 w-full">

                                <!-- Product Image -->
                                <div class="w-16 h-16 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
                                    <img [src]="item.image ? item.image:placeHolderImg" [alt]="item.name"
                                        class="w-full h-full object-cover">
                                </div>

                                <!-- Name and Details -->
                                <div class="ml-3 flex-1">
                                    <h4 class="font-medium" style="margin-bottom: 0;">
                                        {{ item.name }} 
                                    </h4>
                                    <h4 *ngIf="item.startDate" style="margin-bottom: 0; color: gray;font-size: .9rem;">
                                        {{ item.startDate | date:'mediumDate' }}
                                    </h4>
                                </div>

                                <!-- Right Section: Price on top, Quantity adjustment below, Remove button -->
                                <div class="flex flex-col items-end space-y-2 ml-3">

                                    <span class="font-bold text-green-600">
                                        ({{ item.taxRate }}%)
                                        {{ (item.basePrice * (item?.quantity ?? 1)) | currency:'INR':'symbol':'1.2-2' }}
                                    </span>

                                    <div class="flex gap-2 items-center">
                                        <i class="fa-solid fa-trash cursor-pointer text-red-400"
                                            (click)="removeFromCart(i)"></i>
                                        <!-- Quantity adjustment -->
                                        <div class="flex items-center border border-gray-300 rounded">
                                            <button (click)="updateQuantity(i, -1)"
                                                class="w-6 h-6 flex items-center justify-center hover:bg-gray-100 rounded-l">
                                                <i class="fa-solid fa-minus"></i>
                                            </button>
                                            <span
                                                class="w-8 h-6 flex items-center justify-center border-l border-r border-gray-300 text-sm">
                                                {{ item.quantity }}
                                            </span>
                                            <button (click)="updateQuantity(i, 1)"
                                                class="w-6 h-6 flex items-center justify-center hover:bg-gray-100 rounded-r">
                                                <i class="fa-solid fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <!-- Checkout Summary -->
                        <div class="p-4 border-t border-gray-200 flex-shrink-0">
                            <h3 class="font-semibold text-lg mb-3">Order Summary</h3>
                            <div class="space-y-2 mb-4">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span>{{ subtotal.toFixed(2) | currency:'INR':'symbol':'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Tax (8%)</span>
                                    <span>{{ tax.toFixed(2) | currency:'INR':'symbol':'1.2-2'}}</span>
                                </div>
                                <div class="flex justify-between font-bold text-lg mt-2">
                                    <span>Total</span>
                                    <span>{{ total.toFixed(2) | currency:'INR':'symbol':'1.2-2' }}</span>
                                </div>
                            </div>

                            <button (click)="createInvoice()" [disabled]="cart.length === 0" *ngIf="!invoice.status"
                                [ngClass]="{'bg-violet-100 cursor-not-allowed': cart.length === 0, 'cursor-pointer bg-violet-300 hover:bg-violet-400 font-medium': cart.length > 0}"
                                class="w-full py-3 rounded-lg transition-colors">
                                {{invoiceButtonText}}
                            </button>

                            <div class="flex gap-2 mt-4 justify-center" *ngIf="invoice.status">
                                <button *ngFor="let action of getAvailableActions(invoice.status!)"
                                    [disabled]="cart.length === 0"
                                    [ngClass]="[cart.length === 0 ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : actionButtonClasses[action]]"
                                    (click)="handleAction(action, invoice)"
                                    class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-400">
                                    {{ action }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>