<div class="bg-white p-4 rounded-xl shadow-md" #reportCard>
    <!-- Profile Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
        <div class="flex items-center gap-4">
            <div class="relative">
                <div class="h-14 w-14 rounded-full bg-zinc-100 border border-zinc-200 overflow-hidden">
                    <img src="https://api.dicebear.com/9.x/bottts-neutral/svg?seed=Vivian" alt="avatar"
                        class="h-full w-full object-cover opacity-90" />
                </div>
                <div class="absolute -bottom-0.5 -right-0.5 h-3.5 w-3.5 bg-emerald-500 border-2 border-white rounded-full"
                    *ngIf="!isExpired(customer.customer.membershipExpiry)">
                </div>
                <div class="absolute -bottom-0.5 -right-0.5 h-3.5 w-3.5 bg-rose-500 border-2 border-white rounded-full"
                    *ngIf="isExpired(customer.customer.membershipExpiry)">
                </div>
            </div>
            <div>
                <h1 class="text-xl font-semibold tracking-tight text-zinc-900 !mb-0 cursor-pointer">
                    {{customer.customer.firstName}}
                    {{customer.customer.lastName || ''}} </h1>
                <div class="flex items-center gap-2 text-xs text-zinc-500 mt-0.5">
                    <span
                        class="px-1.5 py-0.5 rounded-md bg-zinc-100 border border-zinc-200 text-zinc-600 text-[10px] font-medium uppercase tracking-wide">{{customer.customer.membershipName
                        || 'Basic'}}</span>
                    <span>â€¢</span>
                    <span class="flex items-center gap-1">
                        Membership expires {{customer.customer.membershipExpiry ? (customer.customer.membershipExpiry |
                        date:'dd MMM yyyy') :'Unknown'}}
                    </span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <button mat-stroked-button class="action-button" (click)="copyReportAsImage()"
                *ngIf="customerProgress != null && !processing">
                <i class="fa-brands fa-whatsapp mr-2"></i>
                <span class="action-text"> Share Report</span>
            </button>
            <div class="h-6 w-6 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600 mb-2 mr-2" *ngIf="processing"></div>
        </div>
    </div>
    @if (loader) {
    <div class="flex items-center justify-center">
        <div class="h-10 w-10 animate-spin rounded-full border-4 border-gray-300 border-t-blue-600"></div>
    </div>

    }@else {
    @if (customerProgress != null){
    <!-- KPI Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- Days Visited -->
        <div
            class="group p-4 rounded-xl border border-zinc-200 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] transition-all hover:shadow-[0_4px_12px_rgba(0,0,0,0.04)]">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2 text-zinc-500">
                    <!-- <iconify-icon icon="solar:walking-round-linear" width="18"></iconify-icon> -->
                    <span class="text-xs font-medium">Total Visits</span>
                </div>
                <span
                    class="text-[10px] font-medium text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100"
                    *ngIf="growth > 0"> {{growth}}%
                    mo</span>
                <span
                    class="text-[10px] font-medium text-rose-600 bg-rose-50 px-1.5 py-0.5 rounded border border-rose-100"
                    *ngIf="growth < 0"> {{growth}}%
                    mo</span>
            </div>
            <div class="flex items-end gap-2">
                <span class="text-3xl font-semibold tracking-tight text-zinc-900">{{totalVisits}}</span>
                <span class="text-xs text-zinc-500 mb-1.5">visits</span>
            </div>
            <div class="mt-3 w-full bg-zinc-100 h-1 rounded-full overflow-hidden">
                <div class="bg-zinc-900 h-full rounded-full" [style.width.%]="calculateWidth(totalVisits)"></div>
            </div>
        </div>

        <!-- Longest Streak -->
        <div
            class="group p-4 rounded-xl border border-zinc-200 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] transition-all hover:shadow-[0_4px_12px_rgba(0,0,0,0.04)]">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2 text-zinc-500">
                    <!-- <iconify-icon icon="solar:flame-linear" width="18"></iconify-icon> -->
                    <span class="text-xs font-medium">Longest Streak</span>
                </div>
                <span class="text-[10px] font-medium text-zinc-400">All time</span>
            </div>
            <div class="flex items-end gap-2">
                <span class="text-3xl font-semibold tracking-tight text-zinc-900">{{customerProgress?.streak ||
                    0}}</span>
                <span class="text-xs text-zinc-400 mb-1.5">consecutive days</span>
            </div>
            <div class="flex items-center gap-2 mt-3 text-xs text-zinc-500">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                Current streak: {{customerProgress?.streak || 0}} days
            </div>
        </div>

        <!-- Remaining Days -->
        <div
            class="group p-4 rounded-xl border border-zinc-200 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] transition-all hover:shadow-[0_4px_12px_rgba(0,0,0,0.04)]">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2 text-zinc-500">
                    <!-- <iconify-icon icon="solar:shield-warning-linear" width="18"></iconify-icon> -->
                    <span class="text-xs font-medium">Remaining Days</span>
                </div>
                <span
                    class="text-[10px] font-medium text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded border border-emerald-100">{{customerProgress?.remainingDays
                    > 0 ? 'Active' : 'Expired'}}</span>
            </div>
            <div class="flex items-end gap-2">
                <span class="text-3xl font-semibold tracking-tight text-zinc-900">{{customerProgress?.remainingDays ||
                    0}}</span>
                <span class="text-xs text-zinc-500 mb-1.5">days</span>
            </div>
            <!-- <div class="relative mt-3 w-full bg-zinc-100 h-1.5 rounded-full overflow-hidden">
                    <div class="h-full rounded-full" [class.bg-emerald-500]="customerProgress?.remainingDays > 30"
                        [class.bg-amber-500]="customerProgress?.remainingDays <= 30 && customerProgress?.remainingDays > 7"
                        [class.bg-rose-500]="customerProgress?.remainingDays <= 7"
                        [style.width.%]="calculateRemainingDaysWidth(customerProgress?.remainingDays || 0)"></div>
                </div> -->
        </div>
        <!-- Avg Duration -->
        <div
            class="group p-4 rounded-xl border border-zinc-200 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] transition-all hover:shadow-[0_4px_12px_rgba(0,0,0,0.04)]">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-2 text-zinc-500">
                    <!-- <iconify-icon icon="solar:stopwatch-linear" width="18"></iconify-icon> -->
                    <span class="text-xs font-medium">Avg. Duration</span>
                </div>
            </div>
            <div class="flex items-end gap-2">
                <span class="text-3xl font-semibold tracking-tight text-zinc-900">{{averageDuration || 0}}</span>
                <span class="text-xs text-zinc-500 mb-1.5">minutes</span>
            </div>
            <div class="flex items-center gap-1.5 mt-3">
                <span class="h-1 w-1 rounded-full bg-zinc-300"></span>
                <span class="text-[10px] text-zinc-500">Last 30 days</span>
            </div>
        </div>
    </div>

    <!-- Detailed Metrics Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column: Detailed Charts -->

        <div class="lg:col-span-1 space-y-6">
            <!-- Workout Duration Analysis -->
            <div class="p-6 rounded-xl border border-zinc-200 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)] flex gap-8">
                <div class="mb-8" *ngFor="let monthData of heatmapData">
                    <!-- Month Label -->
                    <div class="text-xs font-medium text-zinc-500 mb-3">
                        {{ monthData.monthLabel }}
                    </div>

                    <div class="flex gap-3">

                        <!-- Weekday Labels (MATCH GRID EXACTLY) -->
                        <div class="grid grid-rows-7 gap-[3px] text-[10px] text-zinc-400">
                            <div class="h-6 flex items-center">Sun</div>
                            <div class="h-6 flex items-center">Mon</div>
                            <div class="h-6 flex items-center">Tue</div>
                            <div class="h-6 flex items-center">Wed</div>
                            <div class="h-6 flex items-center">Thu</div>
                            <div class="h-6 flex items-center">Fri</div>
                            <div class="h-6 flex items-center">Sat</div>
                        </div>

                        <!-- Heatmap Grid -->
                        <div class="overflow-x-auto">
                            <div class="grid grid-rows-7 grid-flow-col gap-[4px] w-max">
                                <ng-container *ngFor="let day of monthData.heatmapData">

                                    <div class="w-6 h-6 rounded-md transition-colors duration-200 cursor-pointer"
                                        [ngClass]="{
                                            'bg-transparent': day.empty,
                                            'bg-zinc-200 cursor-not-allowed': day.future,
                                            'bg-red-200 hover:bg-red-200': !day.future && !day.empty && day.level === 0,
                                            'bg-emerald-200 hover:bg-emerald-300': !day.future && day.level === 1,
                                            'bg-emerald-400 hover:bg-emerald-500': !day.future && day.level === 2,
                                            'bg-emerald-600 hover:bg-emerald-700': !day.future && day.level === 3
                                        }" [title]="
                                            day.empty ? '' :
                                            day.future ? (day.date + ' - Future') :
                                            (day.date + (day.duration ? ' - ' + (day.duration | number:'1.0-0') + ' mins' : ' - No visit'))
                                        ">
                                    </div>

                                </ng-container>
                            </div>

                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- ðŸ“Š BAR SECTION -->
        <div class="lg:col-span-1 space-y-6">
            <div class="p-6 rounded-xl border border-zinc-200 bg-white shadow-[0_2px_8px_rgba(0,0,0,0.02)]">
                <!-- HEADER -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-sm font-semibold text-zinc-900 !mb-0">Workout Duration Analysis</h3>
                        <p class="text-xs text-zinc-500 mt-0.5 !mb-0">
                            Monthly activity heatmap + session comparison
                        </p>
                    </div>
                </div>
                <div class="flex items-end justify-center gap-8 sm:gap-16 h-46 border-b border-zinc-100 relative">

                    <!-- Grid lines -->
                    <div class="absolute inset-0 flex flex-col justify-between pointer-events-none">
                        <div class="w-full h-px border-t border-dashed border-zinc-100"></div>
                        <div class="w-full h-px border-t border-dashed border-zinc-100"></div>
                        <div class="w-full h-px border-t border-dashed border-zinc-100"></div>
                        <div class="w-full h-px border-t border-dashed border-zinc-100"></div>
                        <div class="w-full h-px bg-transparent"></div>
                    </div>

                    <!-- Shortest -->
                    <div class="flex flex-col items-center gap-3 z-10 group">
                        <div class="relative w-12 sm:w-16 bg-zinc-100 rounded-t-sm flex items-end justify-center"
                            [style.height.%]="(shortestDuration / longestDuration) * 100">
                            <div class="mb-2 text-xs font-semibold text-zinc-600">
                                {{shortestDuration}}m
                            </div>
                        </div>
                        <p class="text-xs font-medium text-zinc-500">Shortest</p>
                    </div>

                    <!-- Average -->
                    <div class="flex flex-col items-center gap-3 z-10 group">
                        <div class="relative w-12 sm:w-16 bg-indigo-100 rounded-t-sm flex items-end justify-center"
                            [style.height.%]="(averageDuration / longestDuration) * 100">
                            <div class="mb-2 text-xs font-semibold text-indigo-700">
                                {{averageDuration}}m
                            </div>
                        </div>
                        <p class="text-xs font-medium text-indigo-600">Average</p>
                    </div>

                    <!-- Longest -->
                    <div class="flex flex-col items-center gap-3 z-10 group">
                        <div class="relative w-12 sm:w-16 bg-zinc-800 rounded-t-sm flex items-end justify-center"
                            style="height: 100%;">
                            <div class="mb-2 text-xs font-semibold text-white">
                                {{longestDuration}}m
                            </div>
                        </div>
                        <p class="text-xs font-medium text-zinc-900">Longest</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    }@else{
    <div class="flex items-center justify-center">
        <div class="text-zinc-500 text-xs">Customer Dont have a membership</div>
    </div>
    }
    }

</div>