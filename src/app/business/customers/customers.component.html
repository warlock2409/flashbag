<div class="overlay" *ngIf="!shopCode" style="color: white;">
  <h1 class="text-white!">
    “Get closer than ever to your customers.”
  </h1>
  <h3 class="text-white!">
    Start by creating your shop to build lasting connections with your customers.
  </h3>
</div>

<div class="customers-container">
  <div class="customers-content">
    <!-- Top Bar -->
    <header class="header-section">
      <div class="header-content">
        <div class="header-icon">
          <div class="h-9 w-9 rounded-md bg-blue-200 ring-1 ring-inset ring-neutral-200 grid place-items-center mt-1">
            <span class="text-sm font-semibold tracking-tight"
              style="font-family: 'Inter', ui-sans-serif, system-ui; letter-spacing: -0.02em;">CU</span>
          </div>
        </div>
        <div class="header-text">
          <h1 class="header-title">
            Customers
          </h1>
          <p class="header-subtitle">
            Manage customer accounts, status, and spend
          </p>
        </div>
      </div>

      <div class="header-actions">
        <button mat-stroked-button class="action-button" (click)="importCustomers()">
          <span class="action-text">Import Customer</span>
        </button>
        <button mat-stroked-button class="action-button" (click)="addCustomerMannually()">
          <i class="fa-solid fa-plus mr-2"></i>
          <span class="action-text">Customer</span>
        </button>
      </div>
    </header>

    <!-- Controls -->
    <section class="controls-section">
      <!-- Search -->
      <div class="search-container">
        <div class="search-wrapper">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-lucide="search"
            class="search-icon">
            <path d="m21 21-4.34-4.34"></path>
            <circle cx="11" cy="11" r="8"></circle>
          </svg>
          <input id="search" type="text" placeholder="Search by customer or company…" [(ngModel)]="searchQuery"
            (input)="onSearchChange($event)" class="search-input">
        </div>
      </div>

      <!-- Segmented Filter -->
      <div class="filter-container">
        <div class="filter-wrapper">
          <button data-filter="all" [class.filter-btn-active]="activeFilter === 'all'"
            class="filter-btn" (click)="onFilterChange('all')">
            <span [class.filter-indicator-active]="activeFilter === 'all'"
              class="filter-indicator">•</span>
            <span class="filter-text">All</span>
          </button>
          <button data-filter="active" [class.filter-btn-active]="activeFilter === 'active'"
            class="filter-btn" (click)="onFilterChange('active')">
            <span [class.filter-indicator-active]="activeFilter === 'active'"
              class="filter-indicator filter-indicator-active">•</span>
            <span class="filter-text">Active</span>
          </button>
          <button data-filter="inactive" [class.filter-btn-active]="activeFilter === 'inactive'"
            class="filter-btn" (click)="onFilterChange('inactive')">
            <span [class.filter-indicator-active]="activeFilter === 'inactive'"
              class="filter-indicator">•</span>
            <span class="filter-text">Inactive</span>
          </button>
        </div>
      </div>
    </section>

    

    <mat-paginator [length]="totalElements" [pageSize]="pageSize" aria-label="Select page" class="paginator"
      (page)="onPageChange($event)">
    </mat-paginator>
    
    <!-- Table (Desktop) -->
    <section class="desktop-table-section">
      <div class="table-header">
        <div class="table-header-cell customer-header">Customer</div>
        <div class="table-header-cell contact-header">Contact</div>
        <div class="table-header-cell spend-header">Last Spend</div>
        <div class="table-header-cell total-header">Total Spend</div>
        <div class="table-header-cell membership-header">Membership</div>
        <div class="table-header-cell expiry-header">Expiry</div>
      </div>

      <div class="table-body">
        <!-- Rows -->
        @for (customer of customers; track $index; let rowIndex = $index) {
        <div class="table-row fade-in" [style.animation-delay]="rowIndex * 0.05 + 's'" [attr.data-customer-id]="customer.id" data-status="active">
          <div class="table-cell customer-cell">
            <i class="customer-icon introduced-icon" *ngIf="customer.introduced"></i>
            <i class="customer-icon regular-icon" *ngIf="!customer.introduced"></i>
            <!-- Red dot for deleted customers -->
            <span class="deleted-indicator" *ngIf="customer.deleted === true"></span>
            <span class="customer-name">{{customer.firstName}} {{customer.lastName}}</span>
          </div>
          <div class="table-cell contact-cell">
            <div class="contact-info">{{customer.email}}</div>
            <div class="contact-info">{{customer.contactNumber}}</div>
          </div>
          <div class="table-cell spend-cell">
            {{ customer?.lastSpendDate || '— — —' }}
          </div>
          <div class="table-cell total-cell">{{customer.totalSpent | currency:'INR' }}</div>
          <div class="table-cell membership-cell">{{customer.membershipName}}</div>
          <div class="table-cell expiry-cell">
            <span *ngIf="!customer.membershipExpiry" class="expiry-badge expiry-badge-empty">— — —</span>

            <span *ngIf="customer.membershipExpiry && isExpired(customer.membershipExpiry)"
              class="expiry-badge expiry-badge-expired">{{customer.membershipExpiry}}</span>
              
            <span *ngIf="customer.membershipExpiry && !isExpired(customer.membershipExpiry)"
              class="expiry-badge expiry-badge-active">{{customer.membershipExpiry}}</span>
          </div>
        </div>
        }
      </div>
    </section>

    <!-- Cards (Mobile/Tablet) -->
    <section class="mobile-cards-section">
      <!-- Card -->
      @for (customer of customers; track $index; let rowIndex = $index) {
      <article class="customer-card fade-in" [style.animation-delay]="rowIndex * 0.05 + 's'" [attr.data-customer-id]="customer.id" data-status="active">
        <div class="card-header">
          <div class="card-header-content">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-lucide="user"
              class="card-icon">
              <path d="M20 21a8 8 0 1 0-16 0"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <h3 class="card-title">
               <!-- Red dot for deleted customers -->
              <span class="deleted-indicator" *ngIf="customer.deleted === true"></span>
              {{customer.firstName}} {{customer.lastName}}
            </h3>
          </div>
          <span class="card-status">Active</span>
        </div>
        <div class="card-company">{{customer.companyName}}</div>
        <div class="card-contact">
          <div class="contact-item" *ngIf="customer.email">
            <span class="contact-label">Email:</span> 
            <span class="contact-value">{{customer.email}}</span>
          </div>
          <div class="contact-item" *ngIf="customer.contactNumber">
            <span class="contact-label">Phone:</span> 
            <span class="contact-value">{{customer.contactNumber}}</span>
          </div>
        </div>
        <div class="card-footer">
          <div class="card-amount">{{customer.totalSpent | currency:'INR'}}</div>
          <button class="view-button">
            View
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
              data-lucide="arrow-up-right" class="view-icon">
              <path d="M7 7h10v10"></path>
              <path d="M7 17 17 7"></path>
            </svg>
          </button>
        </div>
      </article>
      }
    </section>

    <!-- Empty state -->
    <div class="empty-state" *ngIf="customers.length == 0">
      <div class="empty-icon-container">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-lucide="inbox"
          class="empty-icon">
          <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline>
          <path
            d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z">
          </path>
        </svg>
      </div>
      <h3 class="empty-title">
        No customers match your filters
      </h3>
      <p class="empty-description">
        Try a different status or clear your search.
      </p>
    </div>
  </div>
</div>